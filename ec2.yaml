AWSTemplateFormatVersion: 2010-09-09
Description: OneNineAI G2 - Task 4 on DevOps and Automation

Parameters:
  ImageID:
    Type: String
    Description: 'RedHat AMI'
    Default: 'ami-0931978297f275f71'
  InstanceType:
    Type: String
    Description: 't2.micro as its included in free tier'
    Default: t2.micro
  KeyName:
    Description: SSH Key pair to securely connect to instance
    Type: AWS::EC2::KeyPair::KeyName
    Default: OneNineG2T4
  SSHLocation: 
      Description: The IP address range that can be used to SSH to the EC2 instances
      Type: String
      MinLength: '9'
      MaxLength: '18'
      Default: 0.0.0.0/0
      AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
      ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
  
Resources:
    EC2Instance:
      Type: AWS::EC2::Instance
      Properties:
        ImageId: !Ref ImageID
        InstanceType: !Ref 'InstanceType'
        KeyName: !Ref 'KeyName'
        UserData: 
          Fn::Base64: !Sub |
            #!/bin/sh
            
            # 1. cloning chatboi-ui from git repo
            git clone https://github.com/mckaywrigley/chatbot-ui

            # 2. install dependencies - sudo apt install npm
            npm i

            # 3. provide OpenAI API Key: OPENAI_API_KEY=YOURKEY in .env.local file in root of repo

            # 4. run app
            npm run dev



    